openapi: 3.0.0
info:
  title: BRD Phone FCM Middleware API
  description: API para registro de tokens Firebase Cloud Messaging (FCM), gestão de usuários com múltiplos dispositivos e disparo de notificações PUSH.
  version: 1.0.0
servers:
  - url: http://168.121.7.18:3000
    description: Servidor Local de Desenvolvimento
tags:
  - name: Gestão de Dispositivos
    description: Operações de Criação, Atualização e Deleção de Tokens por Dispositivo.
  - name: Consulta de Usuário
    description: Verificação de existência e listagem de dispositivos ativos.
  - name: FCM Push
    description: Disparo de notificação de chamada PUSH para todos os dispositivos ativos.
paths:
  /user/upsert:
    post:
      tags:
        - Gestão de Dispositivos
      summary: Cria ou atualiza o Token FCM para um dispositivo específico.
      description: |
        Persiste o token FCM para um usuário e plataforma específicos, reativando o token (isActive=TRUE) e atualizando o timestamp se já existir. Esta rota trata do ciclo de vida do token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userID_Domain
                - token
                - platform
              properties:
                userID_Domain:
                  type: string
                  description: ID do usuário (geralmente no formato SIP).
                  example: sip:123124@pabx04.brdtestes.com.br
                token:
                  type: string
                  description: Token de registro do Firebase (FCM Token).
                  example: dQUf4e9_RbuDcZ2BAXARTu:APA91b...
                platform:
                  type: string
                  enum: [Android, IOS, Extension] 
                  description: Tipo de plataforma do dispositivo.
                  example: Extension
      responses:
        '200':
          description: Token persistido/atualizado com sucesso (isActive redefinido para TRUE).
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Token atualizado/registrado para sip:123124@pabx04.brdtestes.com.br (Extension).
        '400':
          description: Requisição inválida (parâmetros obrigatórios ausentes ou enum inválido).
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: userID_Domain, Token FCM e platform são obrigatórios.

  /user/delete:
    delete:
      tags:
        - Gestão de Dispositivos
      summary: Deleta TODOS os tokens FCM de um usuário.
      description: Remove **todos** os tokens FCM (múltiplos dispositivos) associados a um único userID_Domain.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userID_Domain
              properties:
                userID_Domain:
                  type: string
                  description: ID do usuário cujos tokens serão removidos.
                  example: sip:123124@pabx04.brdtestes.com.br
      responses:
        '200':
          description: Usuário e todos os tokens deletados com sucesso (ou se não existirem).
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Todos os tokens para sip:123124@pabx04.brdtestes.com.br removidos do DB.
        '400':
          description: Requisição inválida.
        '500':
          description: Falha interna ao tentar deletar os tokens no DB.

  /user/deleteEspecificToken:
    delete:
      tags:
        - Gestão de Dispositivos
      summary: Deleta token de dispositivo específico de um usuário.
      description: Remove o token de um dispositivo especifico associado a um userID_Domain.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userID_Domain
                - platform
              properties:
                userID_Domain:
                  type: string
                  description: ID do usuário cujos tokens serão removidos.
                  example: sip:123124@pabx04.brdtestes.com.br
                platform:
                  enum: [Android, IOS, Extension]
                  description: Plataforma do dispositivo cujo token será removido. 
                  example: Extension

      responses:
        '200':
          description: Dispositivo ${platform} de ${userID_Domain} deletado com sucesso (DB).
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Dispositivo ${platform} de ${userID_Domain} deletado com sucesso (DB).
        '400':
          description: Requisição inválida, Algum dos campos da requisição faltando ou incorreto.
        '500':
          description: Falha interna ao tentar deletar os tokens no DB.


  /user/tokens: 
    post:
      tags:
        - Consulta de Usuário
      summary: Retorna todos os dispositivos e tokens ativos de um usuário.
      description: Verifica a existência de um usuário e retorna uma lista detalhada de todos os tokens FCM (dispositivos) ativos e suas plataformas.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userID_Domain
              properties:
                userID_Domain:
                  type: string
                  description: ID do usuário a ser verificado.
                  example: sip:123124@pabx04.brdtestes.com.br
      responses:
        '200':
          description: Usuário encontrado. Retorna a lista de dispositivos ativos.
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                    example: true
                  userID:
                    type: string
                    example: sip:123124@pabx04.brdtestes.com.br
                  message:
                    type: string
                    example: Encontrados 2 dispositivo(s) ativo(s).
                  devices:
                    type: array
                    items:
                      type: object
                      properties:
                        token:
                          type: string
                          description: Token FCM completo.
                        platform:
                          type: string
                          enum: [Android, IOS, Extension]
                        last_active:
                          type: string
                          format: date-time
                          description: Última atualização do token (updatedAt).
                    example:
                      - token: dQUf4e9_RbuDcZ2BAXARTu:APA91b...
                        platform: Android
                        last_active: "2025-10-21T18:00:00.000Z"
                      - token: aBcXyZ_123456...
                        platform: Extension
                        last_active: "2025-10-21T17:55:00.000Z"
        '404':
          description: Nenhum token ativo encontrado para o usuário.
          content:
            application/json:
              schema:
                type: object
                properties:
                  exists:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: O usuário sip:123124@pabx04.brdtestes.com.br não tem tokens ativos no DB.
                  devices:
                    type: array
                    example: []
        '400':
          description: Requisição inválida.

  /firebaseDataPush:
    post:
      tags:
        - FCM Push
      summary: Dispara uma notificação de chamada PUSH para TODOS os dispositivos de um usuário.
      description: |
        Busca TODOS os Tokens FCM ativos do `userID_destino` e envia uma notificação PUSH de alta prioridade (silent/VOIP) para cada dispositivo encontrado. 
        A rota executa a limpeza reativa (desativa tokens expirados/inválidos no DB) e retorna um relatório detalhado por token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userID_destino
                - userID_origem
              properties:
                userID_destino:
                  type: string
                  description: ID do usuário que deve receber a notificação PUSH (destino da chamada).
                  example: sip:123124@pabx04.brdtestes.com.br
                userID_origem:
                  type: string
                  description: ID do usuário que originou a chamada (usado para contexto na notificação).
                  example: sip:13124@pabx04.brdtestes.com.br
      responses:
        '200':
          description: Sucesso no envio para pelo menos um dispositivo. Retorna o relatório detalhado de todos os tokens processados.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                    description: Indica se o processamento foi executado e houve pelo menos um envio bem-sucedido.
                  message:
                    type: string
                    example: Notificação processada. Sucessos: 2, Falhas: 1.
                  results:
                    type: array
                    description: Array detalhado com o status de processamento (sucesso ou falha) de cada Token FCM.
                    items:
                      type: object
                      properties:
                        token:
                          type: string
                          description: O Token FCM que foi processado.
                          example: fzL-sQG4...
                        platform:
                          type: string
                          enum: [Android, IOS, Extension] 
                          description: A plataforma do dispositivo.
                          example: Extension
                        status:
                          type: boolean
                          description: 'Resultado do envio: TRUE para sucesso, FALSE para falha.'
                          example: true
                        messageId:
                          type: string
                          nullable: true
                          description: ID da mensagem do Firebase (somente se status: true).
                          example: projects/project-id/messages/1234567890
                        errorCode:
                          type: string
                          nullable: true
                          description: Código de erro do Firebase (somente se status: false). Ex: messaging/invalid-argument.
                          example: messaging/registration-token-not-registered
                        errorMessage:
                          type: string
                          nullable: true
                          description: Mensagem de erro detalhada, se houver falha.
                          example: The registration token is not a valid FCM registration token
        '400':
          description: Requisição inválida (parâmetros obrigatórios ausentes ou IDs iguais).
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: userID_destino e userID_origem são obrigatórios.
        '404':
          description: Nenhum Token FCM ativo encontrado para o usuário de destino.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Nenhum token FCM ativo encontrado para o UserID de destino.
        '500':
          description: Falha no envio para TODOS os dispositivos (0 sucessos) ou falha interna do DB.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Falha ao enviar notificação para todos os dispositivos. Total de falhas: 3.
                  results:
                    type: array
                    description: Retorna o relatório detalhado das falhas.
                    items:
                      type: object
                      properties:
                        token:
                          type: string
                        platform:
                          type: string
                        status:
                          type: boolean
                        errorCode:
                          type: string
                        errorMessage:
                          type: string